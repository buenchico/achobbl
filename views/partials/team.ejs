<!-- Spinner -->
<div id="loading" class="text-center my-3">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<div id="team" class="container row">
</div>


<script>
  $(function() {
    // Embed server-side variables into JS
    var team = <%- JSON.stringify(data) %>;
    var skillsData = <%- JSON.stringify(skillsData) %>;

    // Published CSV link (replace with your own gid if needed)
    var csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGI8IPIEedTf51WRl4ZzcoE1BZG1pxM4GmLJzW6UfR9L5UuyQL8LzUsxJJFmu0Vey3abhNPkA6N4kV/pub?gid=" + team["gid"] + "&single=true&output=tsv";

    // Show spinner at start
    $("#loading").show();

    $.get(csvUrl, function(csvText) {
      // Split into rows
      var rows = csvText.trim().split("\n");

      var teamName = rows[34].split("\t")[3]
      var teamRace = rows[39].split("\t")[3]
      var coachName = rows[44].split("\t")[3]
      var cash = rows[49].split("\t")[3]
      var teamValue = rows[54].split("\t")[25]
      var reRolls = rows[34].split("\t")[19]
      var fans = rows[38].split("\t")[19]
      var assistants = rows[42].split("\t")[19]
      var cheerleaders = rows[46].split("\t")[19]
      var apothecary = rows[50].split("\t")[19]
      var league = rows[38].split("\t")[8]
      var rules = rows[48].split("\t")[8]

      $("#team").append("<h2>" + teamName + " (" + coachName + ")" + "<span class='badge text-bg-warning float-end'>" + teamValue + "</span>" + "</h2>");

      // Slice rows 2 through 34 (exclusive)
      var limitedRows = rows.slice(2, 34);

      // Step through in increments of 2
      for (var i = 0; i < limitedRows.length; i += 2) {
        var row1 = limitedRows[i].split("\t");
        var row2 = limitedRows[i + 1] ? limitedRows[i + 1].split("\t") : null;

        var innateSkills = row1[8].split(",")
          .map(s => s.trim())
          .filter(function(val) {
            return val && val.trim() !== ""; // skip empty values
          })

        var gainedSkills = row2.slice(8, 14)
          .filter(function(val) {
            return val && val.trim() !== ""; // skip empty values
          })

        var skills = innateSkills.map(skill => {
                      return `<div class="d-inline-block position-relative skill">
                                <span>${skill}</span>
                                <div class="d-none skillBox card">
                                  <div class="card-header">
                                    <strong>${skill}</strong> — ${skillsData[skill]?.type || ''} ${skillsData[skill]?.category || ''}
                                    <!-- Close button -->
                                    <button type="button" class="btn-close float-end" aria-label="Close"></button>
                                  </div>
                                  <div class="card-body">
                                    ${skillsData[skill]?.category || ''}
                                  </div>
                                </div>
                              </div>`
                      })
                      .concat(gainedSkills.map(skill => {
                        return `<div class="d-inline-block position-relative skill">
                                  <span class="text-warning">${skill}</span>
                                  <div class="d-none skillBox card">
                                    <div class="card-header">
                                      <strong>${skill}</strong> — ${skillsData[skill]?.type || ''} ${skillsData[skill]?.category || ''}
                                      <!-- Close button -->
                                      <button type="button" class="btn-close float-end" aria-label="Close"></button>
                                    </div>
                                    <div class="card-body">
                                      ${skillsData[skill]?.category || ''}
                                    </div>
                                  </div>
                                </div>`
                      }))

        // Only proceed if both rows exist
        let oddClass = (i % 4 === 2) ? " bg-secondary-subtle" : "";

        if (row1 && row2 && row1[2] && row1[2].trim() !== "") {
          $("#team").append(
            "<div class='row mb-1"  + oddClass + "'>" +
              "<div class='col'>" +
                "<span class='badge text-bg-secondary'>#" + row1[0] + "</span> " +
                "<span>" + row1[1] + "</span> — " +
                "<span class='secondary text-secondary'>" + row1[2] + "</span>" +
                "</span>" +
              "</div>" +

              // Stats from row1
              "<div class='col d-flex flex-wrap flex-md-row flex-column'>" +
                "<span class='stat-pair me-2'><span class='badge text-dark p-0'>MA</span> <span class='badge text-bg-secondary'>" + row1[3] + "</span></span>" +
                "<span class='stat-pair me-2'><span class='badge text-dark p-0'>ST</span> <span class='badge text-bg-secondary'>" + row1[4] + "</span></span>" +
                "<span class='stat-pair me-2'><span class='badge text-dark p-0'>AG</span> <span class='badge text-bg-secondary'>" + row1[5] + "</span></span>" +
                "<span class='stat-pair me-2'><span class='badge text-dark p-0'>PA</span> <span class='badge text-bg-secondary'>" + row1[6] + "</span></span>" +
                "<span class='stat-pair me-2'><span class='badge text-dark p-0'>AV</span> <span class='badge text-bg-secondary'>" + row1[7] + "</span></span>" +
              "</div>" +
              // Skills from row2
              "<div class='col'>" +
                skills.join(", ") +
              "</div>" +
            "</div>"
          );
        }
      }

      $("#team").append(
        "<div class='row'>" +
          "<div class='col text-start'>" +
            "League: " + league +
          "</div>" +
          "<div class='col text-end'>" +
            "ReRolls: " + reRolls +
          "</div>" +
        "</div>" +
        "<div class='row'>" +
          "<div class='col text-start'>" +
            "Special rules: " + rules +
          "</div>" +
          "<div class='col text-end'>" +
            "Fans: " + fans +
          "</div>" +
        "</div>" +
        "<div class='row'>" +
          "<div class='col text-end'>" +
            "Assistant Coaches: " + assistants +
          "</div>" +
        "</div>" +
        "<div class='row'>" +
          "<div class='col text-end'>" +
            "Cheerleaders: " + cheerleaders +
          "</div>" +
        "</div>" +
        "<div class='row'>" +
          "<div class='col text-end'>" +
            "Apothecary: " + apothecary +
          "</div>" +
        "</div>" +
        "<div class='row'>" +
          "<div class='col text-end'>" +
            "Cash: " + cash +
          "</div>" +
        "</div>"
      );

      // Hide spinner once done
      $("#loading").hide();
    });
  });

  $(document).ready(function() {
    // Toggle when clicking a skill
    $(document).on('click', '.skill', function(e) {
      e.stopPropagation(); // prevent bubbling to document
      $('.skillBox').addClass('d-none')
      $(this).find('.skillBox').toggleClass('d-none');
    });

    // Hide all when clicking anywhere else
    $(document).on('click', function(e) {
      // If the click target is not inside a .skill or .skillBox
      if (!$(e.target).closest('.skill, .skillBox').length) {
        $('.skillBox').addClass('d-none');
      }
    });

    $(document).on('click', '.btn-close', function(e) {
      e.stopPropagation(); // prevent bubbling to document
      $('.skillBox').addClass('d-none')
    });
  });
</script>
